# 实现多关键字逻辑组合全文检索功能

## 1. 设计思路

### 1.1 核心需求
- 支持多关键字，用空格分隔
- 默认逻辑关系为OR
- 支持显式AND和OR运算符
- AND优先级高于OR
- 错误处理和用户体验优化
- 性能优化
- 同时支持本地搜索和ES搜索

### 1.2 技术方案
- 创建搜索表达式解析器，将用户输入解析为抽象语法树(AST)
- 实现AST节点：关键字节点、AND节点、OR节点
- 修改本地搜索服务，根据AST执行搜索
- 修改ES搜索服务，根据AST构建ES查询
- 添加错误处理和用户体验优化

## 2. 实现步骤

### 2.1 创建搜索表达式解析器
- 创建`SearchExpressionParser`类，负责解析用户输入的搜索字符串
- 实现词法分析和语法分析
- 支持AND、OR运算符，AND优先级高于OR

### 2.2 实现抽象语法树节点
- 创建`SearchExpression`接口
- 实现`KeywordExpression`类，代表单个关键字
- 实现`AndExpression`类，代表AND逻辑
- 实现`OrExpression`类，代表OR逻辑

### 2.3 修改本地搜索服务
- 修改`AdvancedSearchService`，使用新的搜索表达式解析器
- 修改`SimpleSearchService`，支持多关键字逻辑组合搜索
- 实现基于AST的本地搜索匹配逻辑

### 2.4 修改ES搜索服务
- 修改`EsSearchServiceImpl`，支持多关键字逻辑组合搜索
- 实现基于AST的ES查询构建，使用Spring Data Elasticsearch的Criteria API
- 确保ES搜索和本地搜索的行为一致

### 2.5 添加错误处理和用户体验优化
- 添加搜索语法验证
- 提供清晰的错误提示
- 添加搜索语法说明

## 3. 代码结构

### 3.1 新增文件
- `com.documentpreview.modules.search.domain.SearchExpression` - 搜索表达式接口
- `com.documentpreview.modules.search.domain.KeywordExpression` - 关键字表达式
- `com.documentpreview.modules.search.domain.AndExpression` - AND表达式
- `com.documentpreview.modules.search.domain.OrExpression` - OR表达式
- `com.documentpreview.modules.search.service.SearchExpressionParser` - 搜索表达式解析器

### 3.2 修改文件
- `com.documentpreview.modules.search.service.AdvancedSearchService` - 支持多关键字逻辑组合搜索
- `com.documentpreview.modules.search.service.SimpleSearchService` - 支持多关键字逻辑组合搜索
- `com.documentpreview.modules.search.service.EsSearchServiceImpl` - 支持多关键字逻辑组合搜索

## 4. 实现细节

### 4.1 搜索表达式解析器
- 使用递归下降法实现语法分析
- 支持的语法：`expression = or_expression`
- `or_expression = and_expression (OR and_expression)*`
- `and_expression = term (AND term)*`
- `term = keyword`

### 4.2 本地搜索匹配逻辑
- 对于每个搜索元数据，根据AST执行匹配
- 关键字匹配：检查文件名、标题和内容是否包含关键字
- AND匹配：所有子表达式都必须匹配
- OR匹配：至少一个子表达式必须匹配

### 4.3 ES搜索查询构建
- 基于AST构建Spring Data Elasticsearch的Criteria对象
- 关键字匹配：使用Criteria.contains()方法
- AND匹配：使用Criteria.and()方法
- OR匹配：使用Criteria.or()方法
- 确保AND优先级高于OR

### 4.4 错误处理
- 处理无效的搜索语法
- 提供清晰的错误信息
- 支持语法自动修正建议

## 5. 性能优化
- 缓存解析结果
- 优化搜索匹配算法
- 减少不必要的文件IO操作
- 优化ES查询构建

## 6. 测试计划
- 测试基本的多关键字搜索
- 测试AND和OR运算符
- 测试运算符优先级
- 测试错误处理
- 测试性能
- 测试本地搜索和ES搜索的一致性

## 7. 用户体验优化
- 添加搜索语法提示
- 提供搜索历史记录
- 添加搜索建议
- 优化搜索结果展示

通过以上实现，系统将支持多关键字逻辑组合全文检索功能，同时兼容本地搜索和ES搜索，满足用户的需求。